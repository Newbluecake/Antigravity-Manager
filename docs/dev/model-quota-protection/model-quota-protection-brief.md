# 模型配额保护 (Model Quota Protection) - 需求简报

> **生成时间**: 2026-01-09
> **访谈轮次**: 第 2 轮
> **细节级别**: standard
> **版本**: v1.0 Final

## 1. 一句话描述

在模型映射阶段引入“主动配额检查”，自动跳过余量低于 1%（可配置）的特定模型，从而避免触发 429 异常。

## 2. 目标用户

- **最终用户**：获得更稳定的请求体验，减少因 429 导致的重试或中断。
- **系统管理员**：通过配置阈值平衡“模型利用率”与“系统稳定性”。

## 3. 核心场景（Top 3）

### 场景 1: 自动绕过高风险账号
- **触发**: 用户发起请求，目标模型映射到账号 A。
- **预检**: 系统检查发现账号 A 的该模型剩余配额为 0.8%（低于 1% 阈值）。
- **结果**: 系统自动跳过账号 A，寻找下一个配额充足的账号，用户无感知。

### 场景 2: 阈值自定义
- **触发**: 管理员希望在资源极度紧张时压榨每一分配额。
- **操作**: 在配置中将 `quota_threshold` 调整为 `0.1%`。
- **结果**: 系统直到余量低于 0.1% 才会禁用该模型。

### 场景 3: 配额恢复
- **触发**: 账号 A 经历了配额刷新周期，余量回到 100%。
- **结果**: 下次定期轮询更新数据后，系统自动恢复账号 A 该模型的映射。

## 4. 关键需求点

**必须有 (P0)**:
- [ ] **主动预检逻辑**：在 `TokenManager` 选择账号时，增加对 `remainingFraction` 的检查。
- [ ] **按模型禁用**：禁用粒度需精确到“特定账号+特定模型”，而非整个账号。
- [ ] **自动恢复机制**：依赖现有的定期轮询机制更新配额状态，实现自动启用。

**应该有 (P1)**:
- [ ] **可配置阈值**：支持在全局配置或账户配置中定义禁用阈值。
- [ ] **警告日志/通知**：当模型因配额不足被跳过时，在日志中记录并尝试在响应中（如 headers）通知前端。

## 5. 明确不做

- **实时配额同步**：不要求每次请求都调用外部 API 同步配额（维持现有的定期轮询）。
- **强制 429 阻断**：如果不满足 1% 阈值但没有其他可用账号，仍允许尝试（兜底逻辑）。

## 6. 关键风险

- **数据滞后性** -> 轮询间隔可能导致数据非实时，仍有极小概率触发 429。通过保留 1% 缓冲位来缓解。

## 7. 下一步

✅ **确认 Brief 后，查看完整 Requirements**:
`docs/dev/model-quota-protection/model-quota-protection-requirements.md`

✅ **在新会话中执行**:
```bash
/dev:spec-dev model-quota-protection --skip-requirements
```
