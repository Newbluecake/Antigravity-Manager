# Model Fallback Chain - 需求简报

> **生成时间**: 2026-01-10
> **访谈轮次**: 第 3 轮
> **细节级别**: standard
> **版本**: v1 Draft

## 1. 一句话描述

将模型映射配置从“一对一”升级为“一对多”链式映射，当首选模型不可用（如 429/5xx）时，立即自动降级尝试备选模型链，直到成功或链条耗尽。

## 2. 目标用户

- **主要用户**: 依赖高可用性的 API 用户，希望在主模型故障时有自动备选方案。
- **次要用户**: 需要灵活调度策略的高级用户。

## 3. 核心场景（Top 3）

### 场景 1: 主模型限流自动切换
- **触发**: 用户请求 `gpt-4`，但在所有账号上 `gpt-4` 都返回 429。
- **配置**: `gpt-4` -> [`gpt-4`, `gpt-4-0613`, `gpt-3.5-turbo`]
- **结果**: 系统自动尝试 `gpt-4-0613`，如果成功则返回结果，用户感知不到错误。

### 场景 2: 服务端错误快速故障转移
- **触发**: `claude-3-opus` 突发 500 错误。
- **配置**: `claude-3-opus` -> [`claude-3-opus`, `claude-3-sonnet`]
- **结果**: 立即切换到 `claude-3-sonnet` 继续服务。

## 4. 关键需求点

**必须有 (P0)**:
- [ ] 后端支持 `AppConfig` 同时解析 String（旧版）和 Array<String>（新版）格式。
- [ ] 代理层实现“立即切换”策略：遇到 429/5xx/40x/NetErr 不重试当前模型，直接尝试链中下一个。
- [ ] 前端设置页新增“列表构建器”UI，支持添加、删除、拖拽排序备选模型。

**应该有 (P1)**:
- [ ] 服务端日志详细记录降级路径（如 "gpt-4 failed -> fallback to gpt-3.5-turbo"）。

## 5. 明确不做

- [ ] 客户端无感：响应头不返回实际使用的模型名。
- [ ] 不做复杂的加权轮询，仅按顺序链式降级。

## 6. 关键风险

- **配置兼容性**: 需确保旧的配置文件（字符串格式）加载时不报错，且能被逻辑正确处理为单元素列表。
- **延迟增加**: 如果链条过长且前面几个模型都超时，整体请求响应时间会显著增加。

## 7. 下一步

✅ **确认 Brief 后，查看完整 Requirements**:
`docs/dev/model-fallback-chain/model-fallback-chain-requirements.md`

✅ **在新会话中执行**:
```bash
/dev:spec-dev model-fallback-chain --skip-requirements
```
