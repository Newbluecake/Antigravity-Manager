# Crash Logging - 需求简报

> **生成时间**: 2026-01-10
> **访谈轮次**: 第 2 轮
> **细节级别**: standard
> **版本**: v1 Final

## 1. 一句话描述

为 Tauri 桌面应用添加本地崩溃日志和异常监控机制,帮助定位"静默闪退"问题的根本原因。

## 2. 目标用户

- 主要用户:开发者(排查崩溃原因、分析堆栈信息)
- 次要用户:高级用户(提供日志文件协助技术支持)

## 3. 核心场景(Top 3)

### 场景 1:应用崩溃时自动记录
- **触发**:应用因未处理的异常而异常退出(Rust panic、JS 错误、系统信号)
- **结果**:系统自动捕获异常堆栈、系统信息、时间戳,写入本地日志文件

### 场景 2:开发者查看崩溃日志
- **触发**:用户报告应用闪退,开发者需要获取日志文件
- **结果**:日志文件存储在标准位置(如 `%APPDATA%/antigravity-tools/logs/`),包含完整的错误堆栈和上下文

### 场景 3:日志自动轮转清理
- **触发**:日志文件达到一定大小或时间(如 7 天前)
- **结果**:系统自动清理旧日志,保留最近的关键信息,防止磁盘占用过大

## 4. 关键需求点

**必须有 (P0)**:
- [ ] Rust 端 panic 捕获(使用 `std::panic::set_hook`)
- [ ] JavaScript 端全局错误捕获(`window.onerror`, `unhandledrejection`)
- [ ] 日志文件写入本地磁盘(包含时间戳、错误信息、堆栈)
- [ ] 日志轮转机制(按时间或大小自动清理旧日志)

**应该有 (P1)**:
- [ ] 系统信息收集(OS 版本、内存使用、CPU 占用)
- [ ] 崩溃前的操作记录(breadcrumb 机制)
- [ ] 日志文件加密或脱敏(避免敏感信息泄露)

## 5. 明确不做

- ❌ **远程日志上传(如 Sentry)**:用户选择了本地日志方案,不集成第三方云服务
- ❌ **实时监控 Dashboard**:仅记录日志文件,不提供可视化界面
- ❌ **性能分析**:仅关注崩溃/错误,不包含性能指标(内存泄漏、CPU 占用趋势等)

## 6. 关键风险

- **Rust panic 导致日志丢失**:panic 时可能无法完整写入文件 → 使用 `panic::catch_unwind` + 同步写入缓解
- **日志文件权限问题**:Windows/macOS 可能因权限不足无法写入 → 使用 Tauri 的 `app_data_dir()` 确保有写权限
- **日志过大占用磁盘**:长时间运行可能生成 GB 级日志 → 实现严格的轮转策略(如保留最近 7 天或最大 100MB)

## 7. 下一步

✅ **确认 Brief 后,查看完整 Requirements**:
`docs/dev/crash-logging/crash-logging-requirements.md`

✅ **在新会话中执行**:
```bash
/dev:spec-dev crash-logging --skip-requirements
```

这将基于 requirements.md 进行:
1. 技术设计
2. 任务拆分
3. TDD 实施
