# 配额优先选择策略 - 需求简报

> **生成时间**: 2026-01-10
> **访谈轮次**: 第 2 轮
> **细节级别**: standard
> **版本**: v1 (Final)

## 1. 一句话描述

在 AI 模型调用时，优先选择剩余配额百分比最低的账号，以快速消耗低额度账户并回收配额。

## 2. 目标用户

- 主要用户：系统管理员、运维人员
- 次要用户：使用 Antigravity-Manager 管理多个 AI 账号的用户

## 3. 核心场景（Top 3）

### 场景 1: 每次 API 调用时智能选择账号
- **触发**: 用户通过代理发起 Claude/Gemini API 请求
- **结果**: 系统自动选择当前剩余配额百分比最低的可用账号（排除限流/锁定账号），完成调用

### 场景 2: 配额接近过期的账号优先消耗
- **触发**: 多个账号同时可用，部分账号配额即将过期或配额较少
- **结果**: 系统按百分比从低到高排序，优先使用百分比最低的账号，避免配额浪费

### 场景 3: 主账号失败时智能降级
- **触发**: 选中的最低配额账号调用失败（API 错误、配额耗尽）
- **结果**: 自动切换到次低配额账号，依次降级尝试，直到成功或所有账号尝试完毕

## 4. 关键需求点

**必须有 (P0)**:
- [ ] 基于百分比剩余配额排序账号（升序：最低配额优先）
- [ ] 每次调用时实时读取配额信息并选择
- [ ] 失败时自动降级到次优账号
- [ ] 保留现有的限流/锁定账号过滤机制

**应该有 (P1)**:
- [ ] 支持配置开关（启用/禁用此策略）
- [ ] 日志记录选择决策（为什么选了这个账号）
- [ ] 兼容现有的粘性会话机制（session binding）

**可以有 (P2)**:
- [ ] 配额消耗统计报告
- [ ] UI 显示当前策略状态

## 5. 明确不做

- ❌ **不修改配额查询 API** - 复用现有 `fetch_quota` 逻辑
- ❌ **不影响订阅等级优先级** - 在同等级内按配额排序，不改变 ULTRA > PRO > FREE 的优先级
- ❌ **不实现基于绝对值的排序** - 仅支持百分比，不按美元金额排序
- ❌ **不做定期调整** - 每次调用时实时决策，不做批量调整

## 6. 关键风险

- **风险 1: 性能影响** - 每次调用都排序可能增加延迟
  - 缓解措施: 账号数量通常较少（<50），排序开销可接受；如需优化可增加配额缓存

- **风险 2: 与粘性会话冲突** - 粘性会话要求固定账号，新策略要求动态切换
  - 缓解措施: 粘性会话优先级更高，仅在新会话分配时应用配额优先策略

- **风险 3: 配额数据过期** - API 缓存导致配额数据不准确
  - 缓解措施: 现有系统已有配额刷新机制，复用即可；考虑失败时强制刷新

## 7. 技术约束

- **语言/框架**: Rust (Tauri)
- **现有模块**:
  - `src-tauri/src/proxy/token_manager.rs` (账号选择逻辑)
  - `src-tauri/src/modules/quota.rs` (配额查询)
  - `src-tauri/src/proxy/config.rs` (配置管理)
- **集成点**:
  - 与 `get_token()` 方法集成
  - 复用 `model_quotas: HashMap<String, f64>` (已存储百分比)
- **性能要求**: 账号选择延迟 < 10ms

## 8. 下一步

✅ **确认 Brief 后，查看完整 Requirements**:
`docs/dev/quota-priority-selection/quota-priority-selection-requirements.md`

✅ **在新会话中执行**:
```bash
/dev:spec-dev quota-priority-selection --skip-requirements
```

这将基于 requirements.md 进行：
1. 技术设计（修改点、数据流、伪代码）
2. 任务拆分（可并行实施）
3. TDD 实施（测试驱动开发）
